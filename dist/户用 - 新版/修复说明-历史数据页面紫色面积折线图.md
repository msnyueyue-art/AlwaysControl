# 修复说明 - 历史数据页面紫色面积折线图

**修复日期:** 2025-11-07
**修复人员:** Claude Code
**修复类型:** 功能实现 + 交互优化

---

## 需求描述

历史数据页面需要默认选中并显示家庭负载的紫色面积折线图,图表颜色与家庭负载图标保持一致。

---

## 实现详情

### 文件: `historical-data.html`

#### 1. 图表HTML结构调整 (lines 165-201)

**修改内容:**
```html
<!-- 能量使用图表 -->
<div style="background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; padding: 20px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <div>
            <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px;">kW</div>
            <div id="currentValue" style="color: #722ed1; font-weight: 600;">2.75</div>
        </div>
        <div style="text-align: right;">
            <div id="currentTimeDisplay" style="font-size: 14px; color: #666;">当前时间: 05:15</div>
            <div id="currentDataLabel" style="font-size: 14px; color: #666;">homeUsageInput 2.75</div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div id="energyChart" class="chart-container" style="height: 300px; position: relative;">
        <canvas id="chartCanvas" width="1000" height="300"></canvas>
        <!-- 悬停提示框 -->
        <div id="chartTooltip" style="position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; display: none; z-index: 100;"></div>
    </div>

    <!-- X轴时间标签 -->
    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; color: #666;">
        <span>00:00</span>
        <span>06:00</span>
        <span>12:00</span>
        <span>18:00</span>
        <span>23:45</span>
    </div>

    <!-- 图表图例 -->
    <div id="chartLegend" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 12px; height: 12px; background: #722ed1; border-radius: 2px;"></div>
            <span style="font-size: 13px; color: #666;">家庭负载</span>
        </div>
    </div>
</div>
```

**关键改动:**
- 添加动态元素ID: `currentValue`, `currentTimeDisplay`, `currentDataLabel`
- 添加悬停提示框容器 `chartTooltip`
- 更新X轴时间标签: 终点从 "23:30" 改为 "23:45"
- 颜色统一使用 `#722ed1` (紫色)

#### 2. 紫色面积折线图实现 (lines 206-447)

**核心功能实现:**

##### 2.1 数据生成 (lines 213-242)
```javascript
// 生成15分钟间隔的24小时数据 (96个数据点: 24*4)
const timePoints = [];
const dataValues = [];

for (let i = 0; i < 96; i++) {
    const totalMinutes = i * 15;
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    timePoints.push(timeStr);

    // 生成模拟家庭负载数据 (0-3kW)
    // 根据不同时段生成不同范围的随机值
    let value;
    if (hours >= 0 && hours < 6) {
        value = 0.3 + Math.random() * 0.4; // 夜间低负载
    } else if (hours >= 6 && hours < 9) {
        value = 1.5 + Math.random() * 1.0; // 早晨
    }
    // ... 其他时段
    dataValues.push(value);
}
```

**数据特点:**
- **时间间隔:** 15分钟
- **数据点数:** 96个 (24小时 × 4)
- **Y轴范围:** 0-3 kW
- **X轴范围:** 00:00-23:45

##### 2.2 图表绘制 (lines 244-303)
```javascript
// 绘制背景网格
ctx.strokeStyle = '#f0f0f0';
ctx.lineWidth = 1;

// 水平网格线 (Y轴)
for (let i = 0; i <= 3; i++) {
    const y = padding + (chartHeight / 3) * i;
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(padding + chartWidth, y);
    ctx.stroke();

    // Y轴标签
    ctx.fillStyle = '#999';
    ctx.font = '12px Arial';
    ctx.textAlign = 'right';
    ctx.fillText((3 - i).toFixed(1), padding - 10, y + 4);
}

// 绘制紫色面积填充
ctx.fillStyle = 'rgba(114, 46, 209, 0.2)'; // #722ed1 with opacity
ctx.beginPath();
ctx.moveTo(points[0].x, padding + chartHeight);
points.forEach(point => {
    ctx.lineTo(point.x, point.y);
});
ctx.lineTo(points[points.length - 1].x, padding + chartHeight);
ctx.closePath();
ctx.fill();

// 绘制紫色折线
ctx.strokeStyle = '#722ed1';
ctx.lineWidth = 2;
ctx.beginPath();
ctx.moveTo(points[0].x, points[0].y);
points.forEach(point => {
    ctx.lineTo(point.x, point.y);
});
ctx.stroke();

// 绘制数据点圆点
points.forEach(point => {
    ctx.fillStyle = '#722ed1';
    ctx.beginPath();
    ctx.arc(point.x, point.y, 2, 0, Math.PI * 2);
    ctx.fill();
});
```

**图表组成:**
1. **背景网格:** 3条水平线,Y轴标签 0, 1.0, 2.0, 3.0
2. **面积填充:** `rgba(114, 46, 209, 0.2)` - 紫色透明度20%
3. **折线:** `#722ed1` - 紫色实线,宽度2px
4. **数据点:** 每个点半径2px的紫色圆点

##### 2.3 鼠标交互 (lines 305-357)
```javascript
// 鼠标交互 - 悬停显示提示框
let selectedPointIndex = 21; // 默认选中 05:15

canvas.addEventListener('mousemove', function(e) {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;

    // 查找最近的数据点
    let closestIndex = 0;
    let minDistance = Infinity;

    points.forEach((point, index) => {
        const distance = Math.abs(point.x - mouseX);
        if (distance < minDistance) {
            minDistance = distance;
            closestIndex = index;
        }
    });

    // 如果鼠标靠近数据点 (30px内)
    if (minDistance < 30) {
        selectedPointIndex = closestIndex;
        const point = points[closestIndex];

        // 显示提示框
        tooltip.style.display = 'block';
        tooltip.textContent = `${point.time}・homeUsageInput ${point.value.toFixed(2)}`;
        tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
        tooltip.style.top = (e.clientY - rect.top - 30) + 'px';

        // 更新右侧显示
        document.getElementById('currentValue').textContent = point.value.toFixed(2);
        document.getElementById('currentTimeDisplay').textContent = `当前时间: ${point.time}`;
        document.getElementById('currentDataLabel').textContent = `homeUsageInput ${point.value.toFixed(2)}`;

        // 重绘图表高亮当前点
        redrawChart();
    }
});

canvas.addEventListener('mouseleave', function() {
    tooltip.style.display = 'none';
    // 恢复默认选中点 (05:15)
    selectedPointIndex = 21;
    const point = points[selectedPointIndex];
    document.getElementById('currentValue').textContent = point.value.toFixed(2);
    document.getElementById('currentTimeDisplay').textContent = `当前时间: ${point.time}`;
    document.getElementById('currentDataLabel').textContent = `homeUsageInput ${point.value.toFixed(2)}`;
    redrawChart();
});
```

**交互特性:**
- **鼠标悬停:** 自动查找最近数据点(30px检测范围)
- **提示框显示:** 格式 "05:15・homeUsageInput 2.75"
- **实时更新:** 右上角显示当前选中点的数值
- **高亮显示:** 选中点放大至半径5px,白色描边
- **默认状态:** 默认选中05:15时刻的数据点

##### 2.4 KPI卡片默认选中 (lines 418-445)
```javascript
// KPI卡片点击事件 - 默认选中家庭负载
document.querySelectorAll('.kpi-card').forEach(card => {
    const device = card.getAttribute('data-device');

    // 默认选中家庭负载
    if (device === 'load') {
        card.style.borderColor = '#722ed1';
        card.style.background = '#f9f0ff';
        card.style.boxShadow = '0 4px 12px rgba(114, 46, 209, 0.3)';
    }

    card.addEventListener('click', function() {
        // 移除其他卡片的选中状态
        document.querySelectorAll('.kpi-card').forEach(c => {
            c.style.borderColor = 'transparent';
            c.style.background = '#fff';
            c.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';
        });

        // 选中当前卡片
        if (device === 'load') {
            this.style.borderColor = '#722ed1';
            this.style.background = '#f9f0ff';
            this.style.boxShadow = '0 4px 12px rgba(114, 46, 209, 0.3)';
        }
    });
});
```

**默认选中效果:**
- **边框颜色:** `#722ed1` (紫色)
- **背景颜色:** `#f9f0ff` (浅紫色)
- **阴影效果:** 紫色阴影,模拟选中高亮

---

## 技术实现要点

### 1. 颜色系统

所有颜色统一使用紫色主题,与家庭负载图标保持一致:

| 元素 | 颜色值 | 用途 |
|------|--------|------|
| 主紫色 | `#722ed1` | 折线、数据点、选中状态 |
| 透明紫色 | `rgba(114, 46, 209, 0.2)` | 面积填充 |
| 浅紫色背景 | `#f9f0ff` | KPI卡片选中背景 |

### 2. Canvas绘图技术

**使用原生Canvas API:**
- `fillStyle` - 设置填充颜色
- `strokeStyle` - 设置描边颜色
- `beginPath()` / `closePath()` - 路径绘制
- `moveTo()` / `lineTo()` - 线条绘制
- `arc()` - 圆形绘制
- `fill()` / `stroke()` - 填充/描边

**优势:**
- 高性能渲染
- 流畅的动画效果
- 精确的像素控制

### 3. 数据结构

```javascript
const points = [
    { x: 40, y: 250, value: 0.35, time: "00:00" },
    { x: 50, y: 245, value: 0.42, time: "00:15" },
    // ... 96个数据点
];
```

每个数据点包含:
- `x`: Canvas横坐标
- `y`: Canvas纵坐标
- `value`: 实际kW值
- `time`: 时间标签 "HH:MM"

---

## 遵循原则

- ✅ **KISS原则** - 使用原生Canvas API,无外部图表库依赖
- ✅ **DRY原则** - 重绘逻辑封装在 `redrawChart()` 函数中
- ✅ **用户体验** - 流畅的鼠标交互,实时反馈
- ✅ **颜色一致性** - 图表颜色与图标颜色完全匹配

---

## 功能验证

**测试要点:**
1. ✅ 页面加载时家庭负载KPI卡片默认选中(紫色边框)
2. ✅ 图表显示紫色面积折线图
3. ✅ Y轴范围0-3kW,标签显示正确
4. ✅ X轴时间从00:00到23:45
5. ✅ 鼠标悬停显示提示框,格式 "HH:MM・homeUsageInput X.XX"
6. ✅ 右上角实时更新当前选中点的数值
7. ✅ 选中点高亮显示(放大+白色描边)
8. ✅ 鼠标离开恢复默认选中点(05:15)

---

## 备注

- 数据为模拟生成,实际使用时需要替换为真实API数据
- 图表支持扩展其他设备(光伏、电网、电池、充电桩),只需添加对应颜色和数据即可
- Canvas尺寸1000×300可根据实际需求调整
