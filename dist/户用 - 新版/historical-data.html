<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²æ•°æ® - æˆ·ç”¨å®¶åº­å‚¨èƒ½-èƒ½æºç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="logo">Always Control Technology</div>
        <div class="header-center">
            <div class="date-display">2025/09/23</div>
            <select class="language-selector">
                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                <option value="en-US">English</option>
            </select>
        </div>
        <div class="header-actions">
            <div class="action-item">
                <div class="action-icon">+</div>
                <div class="action-text">æ·»åŠ è®¾å¤‡</div>
            </div>
            <div class="action-item">
                <div class="action-icon">ğŸ””</div>
                <div class="action-text">ä¿¡æ¯é€šçŸ¥</div>
            </div>
            <div class="action-item">
                <div class="action-icon">ğŸ“–</div>
                <div class="action-text">æ–°æ‰‹æ•™ç¨‹</div>
            </div>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar">
        <div class="user-profile">
            <div class="user-avatar">ğŸ‘¤</div>
            <div class="user-name">user_demo</div>
        </div>
        <div class="nav-menu">
            <a href="index.html" class="nav-item">
                <div class="nav-icon">ğŸ </div>
                <span>é¦–é¡µ</span>
            </a>
            <a href="historical-data.html" class="nav-item active">
                <div class="nav-icon">ğŸ“Š</div>
                <span>å†å²æ•°æ®</span>
            </a>
            <a href="message-center.html" class="nav-item">
                <div class="nav-icon">ğŸ””</div>
                <span>æ¶ˆæ¯ä¸­å¿ƒ</span>
            </a>
            <a href="help-support.html" class="nav-item">
                <div class="nav-icon">â“</div>
                <span>å¸®åŠ©ä¸æ”¯æŒ</span>
            </a>
            <a href="device-management.html" class="nav-item">
                <div class="nav-icon">ğŸ¢</div>
                <span>è®¾å¤‡ç®¡ç†</span>
            </a>
            <a href="settings.html" class="nav-item">
                <div class="nav-icon">âš™ï¸</div>
                <span>è®¾ç½®</span>
            </a>
        </div>
        <div class="version-info">
            <span>ç‰ˆæœ¬å· 1.0.12</span>
            <span>â–¼</span>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <!-- åŒæ­¥æ•°æ®æç¤º -->
        <div style="background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 4px; padding: 8px 12px; margin-bottom: 16px; color: #1890ff; font-size: 12px;">
            è®¾å¤‡åŒæ­¥æ•°æ®æœ‰å¯èƒ½å»¶è¿Ÿ,å¦‚å‘ç°æ•°æ®å¼‚å¸¸,è¯·ç‚¹å‡»: <button class="btn btn-primary sync-data-btn" style="margin-left: 6px; padding: 4px 12px; font-size: 12px;">åŒæ­¥æ•°æ®</button>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div style="background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; gap: 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px;">
                <div class="tab-item active" data-tab="energy" style="padding: 12px 0; border-bottom: 2px solid transparent; color: #666; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    èƒ½é‡ç»Ÿè®¡
                </div>
                <div class="tab-item" data-tab="income" style="padding: 12px 0; border-bottom: 2px solid transparent; color: #666; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    æ”¶ç›Šç»Ÿè®¡
                </div>
                <div class="tab-item" data-tab="carbon" style="padding: 12px 0; border-bottom: 2px solid transparent; color: #666; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    ç»¿è‰²å‡æ’
                </div>
            </div>

            <!-- KPIæŒ‡æ ‡å¡ç‰‡ - ä¼˜åŒ–å°ºå¯¸å’Œæ·»åŠ ç‚¹å‡»äº¤äº’ -->
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;">
                <div class="kpi-card" data-device="load" style="background: #fff; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 36px; height: 36px; background: #722ed1; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">ğŸ </div>
                        <div>
                            <div class="kpi-name" style="font-size: 13px; color: #666; margin-bottom: 2px;">å®¶åº­è´Ÿè½½</div>
                            <div class="kpi-value" style="font-size: 18px; font-weight: 600; color: #333;">27.738kWh</div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" data-device="pv" style="background: #fff; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 36px; height: 36px; background: #faad14; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">â˜€ï¸</div>
                        <div>
                            <div class="kpi-name" style="font-size: 13px; color: #666; margin-bottom: 2px;">å…‰ä¼</div>
                            <div class="kpi-value" style="font-size: 18px; font-weight: 600; color: #333;">12.551kWh</div>
                        </div>
                    </div>
                </div>

                <div class="kpi-card" data-device="grid" style="background: #fff; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 36px; height: 36px; background: #1890ff; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">âš¡</div>
                        <div>
                            <div class="kpi-name" style="font-size: 13px; color: #666; margin-bottom: 2px;">ç”µç½‘</div>
                            <div class="kpi-value" style="font-size: 18px; font-weight: 600; color: #333;">26.348kWh</div>
                        </div>
                    </div>
                </div>

                <div class="kpi-card" data-device="battery" style="background: #fff; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 36px; height: 36px; background: #52c41a; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">ğŸ”‹</div>
                        <div>
                            <div class="kpi-name" style="font-size: 13px; color: #666; margin-bottom: 2px;">ç”µæ± </div>
                            <div class="kpi-value" style="font-size: 18px; font-weight: 600; color: #333;">0.000kWh</div>
                        </div>
                    </div>
                </div>

                <div class="kpi-card" data-device="charging" style="background: #fff; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 36px; height: 36px; background: #fa8c16; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">ğŸš—</div>
                        <div>
                            <div class="kpi-name" style="font-size: 13px; color: #666; margin-bottom: 2px;">å……ç”µæ¡©</div>
                            <div class="kpi-value" style="font-size: 18px; font-weight: 600; color: #333;">11.161kWh</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨æ§åˆ¶æ  -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <select style="padding: 6px 12px; border: 1px solid #d9d9d9; border-radius: 4px; background: #fff;">
                        <option>æ—¥</option>
                        <option>å‘¨</option>
                        <option>æœˆ</option>
                        <option>å¹´</option>
                    </select>
                    <input type="date" value="2025-09-23" style="padding: 6px 12px; border: 1px solid #d9d9d9; border-radius: 4px;">
                </div>
                <button class="btn btn-secondary">
                    <span>ğŸ‘ï¸</span>
                    èƒ½é‡æµå æ¯”
                </button>
            </div>

            <!-- èƒ½é‡ä½¿ç”¨å›¾è¡¨ -->
            <div style="background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; padding: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px;">kW</div>
                        <div id="currentValue" style="color: #722ed1; font-weight: 600;">2.75</div>
                    </div>
                </div>

                <!-- å›¾è¡¨åŒºåŸŸ -->
                <div id="energyChart" class="chart-container" style="height: 300px; position: relative;">
                    <canvas id="chartCanvas" width="1000" height="300"></canvas>
                    <!-- æ‚¬åœæç¤ºæ¡† -->
                    <div id="chartTooltip" style="position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; display: none; z-index: 100;"></div>
                </div>

                <!-- Xè½´æ—¶é—´æ ‡ç­¾ -->
                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; color: #666;">
                    <span>00:00</span>
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>23:45</span>
                </div>

                <!-- å›¾è¡¨å›¾ä¾‹ -->
                <div id="chartLegend" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #722ed1; border-radius: 2px;"></div>
                        <span style="font-size: 13px; color: #666;">å®¶åº­è´Ÿè½½</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/common.js"></script>
    <script>
        // å®¶åº­è´Ÿè½½ç´«è‰²é¢ç§¯æŠ˜çº¿å›¾
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾å¤‡é…ç½®(é¢œè‰²å’Œåç§°) - å¿…é¡»åœ¨æœ€å‰é¢å£°æ˜
            const deviceConfig = {
                load: { color: '#722ed1', bgColor: 'rgba(114, 46, 209, 0.2)', name: 'å®¶åº­è´Ÿè½½', selectedBg: '#f9f0ff' },
                pv: { color: '#faad14', bgColor: 'rgba(250, 173, 20, 0.2)', name: 'å…‰ä¼', selectedBg: '#fffbe6' },
                grid: { color: '#1890ff', bgColor: 'rgba(24, 144, 255, 0.2)', name: 'ç”µç½‘', selectedBg: '#e6f7ff' },
                battery: { color: '#52c41a', bgColor: 'rgba(82, 196, 26, 0.2)', name: 'ç”µæ± ', selectedBg: '#f6ffed' },
                charging: { color: '#fa8c16', bgColor: 'rgba(250, 140, 22, 0.2)', name: 'å……ç”µæ¡©', selectedBg: '#fff7e6' }
            };

            let currentDevice = 'load'; // å½“å‰é€‰ä¸­è®¾å¤‡
            let currentTab = 'energy'; // å½“å‰é€‰ä¸­æ ‡ç­¾é¡µ

            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            const tooltip = document.getElementById('chartTooltip');

            // ç”Ÿæˆ15åˆ†é’Ÿé—´éš”çš„24å°æ—¶æ•°æ® (96ä¸ªæ•°æ®ç‚¹: 24*4)
            const timePoints = [];
            const dataValues = [];

            for (let i = 0; i < 96; i++) {
                const totalMinutes = i * 15;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                timePoints.push(timeStr);

                // ç”Ÿæˆæ¨¡æ‹Ÿå®¶åº­è´Ÿè½½æ•°æ® (0-3kW)
                let value;
                if (hours >= 0 && hours < 6) {
                    value = 0.3 + Math.random() * 0.4; // å¤œé—´ä½è´Ÿè½½ 0.3-0.7
                } else if (hours >= 6 && hours < 9) {
                    value = 1.5 + Math.random() * 1.0; // æ—©æ™¨ 1.5-2.5
                } else if (hours >= 9 && hours < 12) {
                    value = 0.8 + Math.random() * 0.6; // ä¸Šåˆ 0.8-1.4
                } else if (hours >= 12 && hours < 14) {
                    value = 2.0 + Math.random() * 0.8; // åˆé¤æ—¶é—´ 2.0-2.8
                } else if (hours >= 14 && hours < 18) {
                    value = 0.6 + Math.random() * 0.5; // ä¸‹åˆ 0.6-1.1
                } else if (hours >= 18 && hours < 22) {
                    value = 2.2 + Math.random() * 0.7; // æ™šé¤åŠæ™šä¸Š 2.2-2.9
                } else {
                    value = 1.0 + Math.random() * 0.8; // æ·±å¤œ 1.0-1.8
                }
                dataValues.push(value);
            }

            // ç»˜åˆ¶ç´«è‰²é¢ç§¯æŠ˜çº¿å›¾
            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const maxValue = 3.0; // Yè½´æœ€å¤§å€¼

            // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;

            // æ°´å¹³ç½‘æ ¼çº¿ (Yè½´)
            for (let i = 0; i <= 3; i++) {
                const y = padding + (chartHeight / 3) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();

                // Yè½´æ ‡ç­¾
                ctx.fillStyle = '#999';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText((3 - i).toFixed(1), padding - 10, y + 4);
            }

            // è®¡ç®—æ•°æ®ç‚¹åæ ‡
            const points = dataValues.map((value, index) => {
                const x = padding + (index / (dataValues.length - 1)) * chartWidth;
                const y = padding + chartHeight - (value / maxValue) * chartHeight;
                return { x, y, value, time: timePoints[index] };
            });

            // ç»˜åˆ¶ç´«è‰²é¢ç§¯å¡«å……
            ctx.fillStyle = 'rgba(114, 46, 209, 0.2)'; // #722ed1 with opacity
            ctx.beginPath();
            ctx.moveTo(points[0].x, padding + chartHeight);
            points.forEach(point => {
                ctx.lineTo(point.x, point.y);
            });
            ctx.lineTo(points[points.length - 1].x, padding + chartHeight);
            ctx.closePath();
            ctx.fill();

            // ç»˜åˆ¶ç´«è‰²æŠ˜çº¿
            ctx.strokeStyle = '#722ed1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            points.forEach(point => {
                ctx.lineTo(point.x, point.y);
            });
            ctx.stroke();

            // ç»˜åˆ¶æ•°æ®ç‚¹åœ†ç‚¹
            points.forEach(point => {
                ctx.fillStyle = '#722ed1';
                ctx.beginPath();
                ctx.arc(point.x, point.y, 2, 0, Math.PI * 2);
                ctx.fill();
            });

            // é¼ æ ‡äº¤äº’ - æ‚¬åœæ˜¾ç¤ºæç¤ºæ¡†
            let selectedPointIndex = 21; // é»˜è®¤é€‰ä¸­ 05:15 (21 * 15 = 315åˆ†é’Ÿ = 5å°æ—¶15åˆ†)

            function redrawChart() {
                // ä½¿ç”¨å½“å‰è®¾å¤‡é…ç½®çš„é¢œè‰²
                const currentConfig = window.currentConfig || deviceConfig['load'];
                const currentPoints = window.currentPoints || points;

                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // é‡ç»˜ç½‘æ ¼
                ctx.strokeStyle = '#f0f0f0';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 3; i++) {
                    const y = padding + (chartHeight / 3) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(padding + chartWidth, y);
                    ctx.stroke();
                    ctx.fillStyle = '#999';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'right';
                    ctx.fillText((3 - i).toFixed(1), padding - 10, y + 4);
                }

                // é‡ç»˜é¢ç§¯
                ctx.fillStyle = currentConfig.bgColor;
                ctx.beginPath();
                ctx.moveTo(currentPoints[0].x, padding + chartHeight);
                currentPoints.forEach(point => ctx.lineTo(point.x, point.y));
                ctx.lineTo(currentPoints[currentPoints.length - 1].x, padding + chartHeight);
                ctx.closePath();
                ctx.fill();

                // é‡ç»˜æŠ˜çº¿
                ctx.strokeStyle = currentConfig.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(currentPoints[0].x, currentPoints[0].y);
                currentPoints.forEach(point => ctx.lineTo(point.x, point.y));
                ctx.stroke();

                // é‡ç»˜æ•°æ®ç‚¹
                currentPoints.forEach((point, index) => {
                    ctx.fillStyle = currentConfig.color;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // é«˜äº®é€‰ä¸­ç‚¹
                    if (index === selectedPointIndex) {
                        ctx.fillStyle = currentConfig.color;
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                });
            }

            // åˆå§‹ç»˜åˆ¶
            redrawChart();

            // ç»˜åˆ¶æŒ‡å®šè®¾å¤‡çš„å›¾è¡¨
            function drawDeviceChart(device) {
                currentDevice = device;
                const config = deviceConfig[device];

                // æ›´æ–°å›¾ä¾‹
                document.getElementById('chartLegend').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: ${config.color}; border-radius: 2px;"></div>
                        <span style="font-size: 13px; color: #666;">${config.name}</span>
                    </div>
                `;

                // æ›´æ–°currentValueé¢œè‰²
                document.getElementById('currentValue').style.color = config.color;

                // é‡æ–°ç”Ÿæˆæ•°æ®å¹¶ç»˜åˆ¶(æ¯ä¸ªè®¾å¤‡çš„æ•°æ®æ¨¡å¼ä¸åŒ)
                const newDataValues = [];
                for (let i = 0; i < 96; i++) {
                    const totalMinutes = i * 15;
                    const hours = Math.floor(totalMinutes / 60);
                    let value;

                    // æ ¹æ®è®¾å¤‡ç±»å‹ç”Ÿæˆä¸åŒçš„æ•°æ®æ¨¡å¼
                    if (device === 'load') {
                        // å®¶åº­è´Ÿè½½: æ—©æ™šé«˜å³°
                        if (hours >= 0 && hours < 6) value = 0.3 + Math.random() * 0.4;
                        else if (hours >= 6 && hours < 9) value = 1.5 + Math.random() * 1.0;
                        else if (hours >= 9 && hours < 12) value = 0.8 + Math.random() * 0.6;
                        else if (hours >= 12 && hours < 14) value = 2.0 + Math.random() * 0.8;
                        else if (hours >= 14 && hours < 18) value = 0.6 + Math.random() * 0.5;
                        else if (hours >= 18 && hours < 22) value = 2.2 + Math.random() * 0.7;
                        else value = 1.0 + Math.random() * 0.8;
                    } else if (device === 'pv') {
                        // å…‰ä¼: ç™½å¤©é«˜,æ—©æ™šä½
                        if (hours >= 6 && hours < 18) value = 1.5 + Math.random() * 1.5;
                        else value = 0;
                    } else if (device === 'grid') {
                        // ç”µç½‘: è¾ƒå¹³ç¨³æ³¢åŠ¨
                        value = 1.0 + Math.random() * 1.0;
                    } else if (device === 'battery') {
                        // ç”µæ± : å……æ”¾ç”µæ¨¡å¼
                        if (hours >= 9 && hours < 16) value = 1.5 + Math.random() * 1.0;
                        else value = 0.2 + Math.random() * 0.3;
                    } else if (device === 'charging') {
                        // å……ç”µæ¡©: ç‰¹å®šæ—¶æ®µä½¿ç”¨
                        if ((hours >= 7 && hours < 9) || (hours >= 18 && hours < 21)) value = 2.0 + Math.random() * 0.8;
                        else value = 0.1 + Math.random() * 0.2;
                    }

                    newDataValues.push(value);
                }

                // æ›´æ–°pointsæ•°ç»„
                const newPoints = newDataValues.map((value, index) => {
                    const x = padding + (index / (newDataValues.length - 1)) * chartWidth;
                    const y = padding + chartHeight - (value / maxValue) * chartHeight;
                    return { x, y, value, time: timePoints[index] };
                });

                // ä¿å­˜åˆ°å…¨å±€,ä¾›é¼ æ ‡äº‹ä»¶ä½¿ç”¨
                window.currentPoints = newPoints;
                window.currentConfig = config;

                // æ¸…ç©ºç”»å¸ƒå¹¶é‡ç»˜
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // é‡ç»˜ç½‘æ ¼
                ctx.strokeStyle = '#f0f0f0';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 3; i++) {
                    const y = padding + (chartHeight / 3) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(padding + chartWidth, y);
                    ctx.stroke();
                    ctx.fillStyle = '#999';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'right';
                    ctx.fillText((3 - i).toFixed(1), padding - 10, y + 4);
                }

                // ç»˜åˆ¶é¢ç§¯
                ctx.fillStyle = config.bgColor;
                ctx.beginPath();
                ctx.moveTo(newPoints[0].x, padding + chartHeight);
                newPoints.forEach(point => ctx.lineTo(point.x, point.y));
                ctx.lineTo(newPoints[newPoints.length - 1].x, padding + chartHeight);
                ctx.closePath();
                ctx.fill();

                // ç»˜åˆ¶æŠ˜çº¿
                ctx.strokeStyle = config.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(newPoints[0].x, newPoints[0].y);
                newPoints.forEach(point => ctx.lineTo(point.x, point.y));
                ctx.stroke();

                // ç»˜åˆ¶æ•°æ®ç‚¹
                newPoints.forEach((point, index) => {
                    ctx.fillStyle = config.color;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // é«˜äº®é€‰ä¸­ç‚¹
                    if (index === selectedPointIndex) {
                        ctx.fillStyle = config.color;
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                });

                // æ›´æ–°å·¦ä¸Šè§’æ•°å€¼
                const defaultPoint = newPoints[selectedPointIndex];
                document.getElementById('currentValue').textContent = defaultPoint.value.toFixed(2);
            }

            // åˆå§‹åŒ–:ä¿å­˜å…¨å±€å˜é‡ä¾›é¼ æ ‡äº‹ä»¶ä½¿ç”¨
            window.currentPoints = points;
            window.currentConfig = deviceConfig['load'];

            // KPIå¡ç‰‡ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.kpi-card').forEach(card => {
                const device = card.getAttribute('data-device');

                // é»˜è®¤é€‰ä¸­å®¶åº­è´Ÿè½½
                if (device === 'load') {
                    card.style.borderColor = deviceConfig[device].color;
                    card.style.background = deviceConfig[device].selectedBg;
                    card.style.boxShadow = `0 4px 12px ${deviceConfig[device].bgColor}`;
                }

                card.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–å¡ç‰‡çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.kpi-card').forEach(c => {
                        c.style.borderColor = 'transparent';
                        c.style.background = '#fff';
                        c.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';
                    });

                    // é€‰ä¸­å½“å‰å¡ç‰‡
                    const config = deviceConfig[device];
                    this.style.borderColor = config.color;
                    this.style.background = config.selectedBg;
                    this.style.boxShadow = `0 4px 12px ${config.bgColor}`;

                    // ç»˜åˆ¶å¯¹åº”è®¾å¤‡çš„å›¾è¡¨
                    drawDeviceChart(device);
                });
            });

            // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.getAttribute('data-tab');

                    // ç§»é™¤å…¶ä»–æ ‡ç­¾çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.tab-item').forEach(t => {
                        t.classList.remove('active');
                    });

                    // é€‰ä¸­å½“å‰æ ‡ç­¾
                    this.classList.add('active');
                    currentTab = tabType;

                    // è¿™é‡Œå¯ä»¥æ ¹æ®ä¸åŒæ ‡ç­¾é¡µæ˜¾ç¤ºä¸åŒå†…å®¹
                    // ç›®å‰æ‰€æœ‰æ ‡ç­¾é¡µéƒ½æ˜¾ç¤ºèƒ½é‡å›¾è¡¨
                    console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabType);
                });
            });

            // æ›´æ–°é¼ æ ‡äº‹ä»¶ä½¿ç”¨å…¨å±€å˜é‡
            canvas.addEventListener('mousemove', function(e) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;

                // æŸ¥æ‰¾æœ€è¿‘çš„æ•°æ®ç‚¹
                let closestIndex = 0;
                let minDistance = Infinity;

                window.currentPoints.forEach((point, index) => {
                    const distance = Math.abs(point.x - mouseX);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestIndex = index;
                    }
                });

                // å¦‚æœé¼ æ ‡é è¿‘æ•°æ®ç‚¹
                if (minDistance < 30) {
                    selectedPointIndex = closestIndex;
                    const point = window.currentPoints[closestIndex];

                    // æ˜¾ç¤ºæç¤ºæ¡†
                    tooltip.style.display = 'block';
                    tooltip.textContent = `${point.time}ãƒ»${window.currentConfig.name} ${point.value.toFixed(2)}`;
                    tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                    tooltip.style.top = (e.clientY - rect.top - 30) + 'px';

                    // æ›´æ–°å·¦ä¸Šè§’æ˜¾ç¤ºçš„kWå€¼
                    document.getElementById('currentValue').textContent = point.value.toFixed(2);

                    // é‡ç»˜å›¾è¡¨é«˜äº®å½“å‰ç‚¹
                    drawDeviceChart(currentDevice);
                } else {
                    tooltip.style.display = 'none';
                }
            });

            // é¼ æ ‡ç¦»å¼€ç”»å¸ƒæ—¶æ¢å¤é»˜è®¤çŠ¶æ€
            canvas.addEventListener('mouseleave', function() {
                tooltip.style.display = 'none';
                selectedPointIndex = 21; // æ¢å¤é»˜è®¤é€‰ä¸­ç‚¹ 05:15
                const point = window.currentPoints[selectedPointIndex];
                document.getElementById('currentValue').textContent = point.value.toFixed(2);
                drawDeviceChart(currentDevice);
            });
        });
    </script>
</body>
</html>
